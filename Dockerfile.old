# Dockerfile.base - 基础镜像（包含AI模型）
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    pkg-config \
    default-libmysqlclient-dev \
    && rm -rf /var/lib/apt/lists/*

# 安装核心AI依赖（这些很少变化）
RUN pip install --no-cache-dir \
    torch==2.8.0 \
    transformers==4.55.4 \
    sentence-transformers==5.1.0 \
    faiss-cpu==1.12.0 \
    langchain==0.3.27 \
    langchain-community==0.3.27 \
    langchain-huggingface==0.3.1 \
    -i https://pypi.tuna.tsinghua.edu.cn/simple/

# 下载并缓存嵌入模型（关键优化点）
RUN git clone https://www.modelscope.cn/Qwen/Qwen3-Embedding-0.6B.git

# 预热模型（可选但推荐）
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('./Qwen3-Embedding-0.6B')" || true

# 创建非root用户
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser